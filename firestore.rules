rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Character sheets (existing)
    match /characters/{odId} {
      allow read, write: if request.auth != null && request.auth.uid == odId;
    }

    // Shared Investigation boards
    match /boards/{boardId} {
      // Helper function to check if user is a member
      function isMember() {
        return request.auth != null &&
               request.auth.uid in resource.data.members;
      }

      // Helper function to check if user is owner
      function isOwner() {
        return request.auth != null &&
               resource.data.ownerId == request.auth.uid;
      }

      // Helper function to check if user is editor or owner
      function canEdit() {
        return request.auth != null &&
               request.auth.uid in resource.data.members &&
               (resource.data.members[request.auth.uid].role == 'owner' ||
                resource.data.members[request.auth.uid].role == 'editor');
      }

      // Allow read if user is a member OR if checking shareCode for joining
      allow read: if request.auth != null &&
                    (request.auth.uid in resource.data.members ||
                     resource.data.shareCode != null);

      // Allow create if authenticated (new board)
      allow create: if request.auth != null &&
                      request.resource.data.ownerId == request.auth.uid;

      // Allow update if member with edit rights, or joining via shareCode
      allow update: if request.auth != null &&
                      (canEdit() ||
                       // Allow joining via shareCode
                       (resource.data.shareCode != null &&
                        request.resource.data.members[request.auth.uid] != null));

      // Allow delete only by owner
      allow delete: if isOwner();

      // Cards subcollection
      match /cards/{cardId} {
        allow read: if request.auth != null &&
                      request.auth.uid in get(/databases/$(database)/documents/boards/$(boardId)).data.members;
        allow write: if request.auth != null &&
                       request.auth.uid in get(/databases/$(database)/documents/boards/$(boardId)).data.members &&
                       (get(/databases/$(database)/documents/boards/$(boardId)).data.members[request.auth.uid].role == 'owner' ||
                        get(/databases/$(database)/documents/boards/$(boardId)).data.members[request.auth.uid].role == 'editor');
      }

      // Links subcollection
      match /links/{linkId} {
        allow read: if request.auth != null &&
                      request.auth.uid in get(/databases/$(database)/documents/boards/$(boardId)).data.members;
        allow write: if request.auth != null &&
                       request.auth.uid in get(/databases/$(database)/documents/boards/$(boardId)).data.members &&
                       (get(/databases/$(database)/documents/boards/$(boardId)).data.members[request.auth.uid].role == 'owner' ||
                        get(/databases/$(database)/documents/boards/$(boardId)).data.members[request.auth.uid].role == 'editor');
      }

      // Presence subcollection (ephemeral, all members can read/write their own)
      match /presence/{odId} {
        allow read: if request.auth != null &&
                      request.auth.uid in get(/databases/$(database)/documents/boards/$(boardId)).data.members;
        allow write: if request.auth != null &&
                       request.auth.uid == odId &&
                       request.auth.uid in get(/databases/$(database)/documents/boards/$(boardId)).data.members;
      }
    }
  }
}
